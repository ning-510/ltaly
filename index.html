<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¾©å¤§åˆ©èœœæœˆæ‰‹å¸³ ğŸ‡®ğŸ‡¹ 10æ—¥</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module" src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f7f3e8; background-image: url("data:image/svg+xml,%3Csvg width='42' height='44' viewBox='0 0 42 44' xmlns='http://www.w3.org/2000/svg'%3E%3Cg id='Page-1' fill='none' fill-rule='evenodd'%3E%3Cg id='brick-wall' fill='%23e0d8c0' fill-opacity='0.4'%3E%3Cpath d='M0 0h42v44H0z'/%3E%3Cpath d='M0 4h20v24H0zM22 10h20v24H22z' opacity='.5'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E"); padding-bottom: 90px; }
        .tag { padding: 2px 8px; border-radius: 8px; font-weight: 600; font-size: 0.75rem; display: inline-flex; align-items: center; }
        .scrapbook-card { border: 2px solid #5a5a5a; box-shadow: 6px 6px 0px rgba(90, 90, 90, 0.2); transition: transform 0.2s; }
        .f1-card { background-color: #151515; color: #fff; border: 2px solid #e10600; border-radius: 0.75rem; overflow: hidden; box-shadow: 4px 4px 0px rgba(225, 6, 0, 0.4); margin-bottom: 1rem; }
        .f1-header { background-color: #e10600; color: white; padding: 0.5rem 0.75rem; font-weight: 800; font-size: 0.9rem; display: flex; align-items: center; justify-content: space-between; letter-spacing: 0.05em; }
        .f1-body { padding: 0.75rem; color: #fff; font-size: 0.9rem; font-weight: 500; }
        .map-container { position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; border-radius: 0.75rem; border: 1px solid #ddd; }
        .map-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: #fff; border-top: 1px solid #e5e7eb; display: flex; justify-content: space-around; padding: 10px 0; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); z-index: 50; }
        .nav-item { display: flex; flex-direction: column; align-items: center; font-size: 0.75rem; color: #6b7280; width: 100%; padding: 4px 0; }
        .nav-item.active { color: #dc2626; }
        .day-selector { display: flex; overflow-x: auto; gap: 0.5rem; padding: 0.5rem 0; scrollbar-width: none; }
        .day-selector::-webkit-scrollbar { display: none; }
        .day-chip { white-space: nowrap; padding: 0.25rem 0.75rem; border-radius: 999px; background: #e5e7eb; color: #4b5563; font-size: 0.875rem; font-weight: 600; cursor: pointer; border: 1px solid transparent; }
        .day-chip.active { background: #dc2626; color: white; box-shadow: 0 2px 4px rgba(220, 38, 38, 0.3); }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .spinner { border: 2px solid rgba(0, 0, 0, 0.1); border-left-color: #dc2626; border-radius: 50%; width: 16px; height: 16px; animation: spin 1s linear infinite; display: inline-block; vertical-align: middle; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 100; }
    </style>
</head>
<body class="min-h-screen">

    <div id="app" class="max-w-xl mx-auto p-4">
        <header class="flex justify-between items-center mb-4 pt-2">
            <div>
                <h1 class="text-2xl font-bold text-gray-800 tracking-wider">ğŸ‡®ğŸ‡¹ ç¾©å¤§åˆ©èœœæœˆ</h1>
                <p class="text-xs text-gray-500">2025/12/05 - 12/14</p>
            </div>
            <div class="text-right">
                <span id="header-day-display" class="bg-red-100 text-red-800 text-xs font-bold px-2 py-1 rounded-lg">Day 1</span>
            </div>
        </header>
        <main id="main-content" class="pb-4"></main>
    </div>

    <nav class="bottom-nav">
        <button onclick="switchTab('itinerary')" class="nav-item active" id="nav-itinerary"><i data-lucide="map-pinned" class="w-6 h-6 mb-1"></i><span>è¡Œç¨‹</span></button>
        <button onclick="switchTab('places')" class="nav-item" id="nav-places"><i data-lucide="map" class="w-6 h-6 mb-1"></i><span>ç§æˆ¿é»</span></button>
        <button onclick="switchTab('expenses')" class="nav-item" id="nav-expenses"><i data-lucide="wallet" class="w-6 h-6 mb-1"></i><span>è¨˜å¸³</span></button>
        <button onclick="switchTab('notes')" class="nav-item" id="nav-notes"><i data-lucide="notebook-text" class="w-6 h-6 mb-1"></i><span>é ˆçŸ¥</span></button>
    </nav>

    <div id="message-modal" class="modal-overlay hidden">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-64 text-center">
            <div id="modal-icon" class="mb-3 flex justify-center text-blue-500"></div>
            <p id="modal-text" class="text-gray-800 font-bold mb-4"></p>
            <button onclick="closeModal()" class="bg-gray-800 text-white px-4 py-2 rounded-lg text-sm w-full">å¥½</button>
        </div>
    </div>

    <div id="confirm-modal" class="modal-overlay hidden">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-72">
            <p class="font-bold text-lg text-gray-800 mb-2">âš ï¸ ç¢ºèªæ“ä½œ</p>
            <p id="confirm-text" class="text-sm text-gray-600 mb-6"></p>
            <div class="flex justify-end gap-3">
                <button onclick="closeConfirm(false)" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg text-sm font-semibold">å–æ¶ˆ</button>
                <button onclick="closeConfirm(true)" class="px-4 py-2 bg-red-600 text-white rounded-lg text-sm font-semibold">ç¢ºå®š</button>
            </div>
        </div>
    </div>

    <script>
        // --- 1. CONSTANTS & DATA ---
        const itineraryData = [
            {
                day: 1, date: '12/05 (äº”)', location: 'å°åŒ— â†’ æœæ‹œ', lat: 25.0797, lng: 121.2342, locationName: 'ğŸ“ æ¡ƒåœ’ Taoyuan', weather: { temp: '18Â°C - 22Â°C', icon: 'ğŸŒ¤ï¸', condition: 'èˆ’é©', currentTemp: '20Â°C' },
                main: 'é›†åˆï¼šæ¡ƒåœ’æ©Ÿå ´ç¬¬äºŒèˆªå»ˆ',
                details: [
                    { type: 'info', title: 'é›†åˆè³‡è¨Š', content: '20:00 æ¡ƒåœ’æ©Ÿå ´ç¬¬äºŒèˆªå»ˆ é˜¿è¯é…‹èˆªç©ºåœ˜é«”æ«ƒå°', color: 'bg-red-100' },
                    { type: 'flight', title: 'é˜¿è¯é…‹èˆªç©º EK367', content: '23:00 å°åŒ— TPE âœˆï¸ 04:55+1 æœæ‹œ DXB (é£›è¡Œ 09h55m)', color: 'bg-blue-100' },
                    { type: 'checkin', title: 'â° ç·šä¸Šå ±åˆ° (èµ·é£›å‰48h)', content: 'ç¾åœ¨å³å¯å ±åˆ°ï¼<br>ğŸ‡¹ğŸ‡¼ å°ç£: 12/03 23:00<br>ğŸ‡¦ğŸ‡ª æœæ‹œ: 12/03 19:00<br>ğŸ‡®ğŸ‡¹ ç¾©å¤§åˆ©: 12/03 16:00', color: 'bg-purple-100 border-l-4 border-purple-500' },
                    { type: 'meal', title: 'æ—©é¤', content: 'æº«æš–çš„å®¶', color: 'bg-green-50' }, { type: 'meal', title: 'åˆé¤', content: 'æº«æš–çš„å®¶', color: 'bg-green-50' }, { type: 'meal', title: 'æ™šé¤', content: 'æ©Ÿä¸Šé¤é£Ÿ', color: 'bg-green-100' }
                ]
            },
            {
                day: 2, date: '12/06 (å…­)', location: 'æœæ‹œ â†’ ç±³è˜­ (Milan)', lat: 45.4642, lng: 9.1900, locationName: 'ğŸ“ ç±³è˜­ Milan', weather: { temp: '2Â°C - 8Â°C', icon: 'ğŸŒ¥ï¸', condition: 'æ¶¼çˆ½', currentTemp: '5Â°C' },
                main: 'ç±³è˜­å¸‚å€è§€å…‰ & F1 æ’ä½è³½',
                details: [
                    { type: 'flight', title: 'é˜¿è¯é…‹èˆªç©º EK205', content: '09:05 æœæ‹œ DXB âœˆï¸ 13:10 ç±³è˜­ MXP (é£›è¡Œ 07h05m)', color: 'bg-blue-100' },
                    { type: 'checkin', title: 'â° ç·šä¸Šå ±åˆ° (èµ·é£›å‰48h)', content: 'é–‹æ”¾æ™‚é–“:<br>ğŸ‡¹ğŸ‡¼ å°ç£: 12/04 13:05<br>ğŸ‡¦ğŸ‡ª æœæ‹œ: 12/04 09:05<br>ğŸ‡®ğŸ‡¹ ç¾©å¤§åˆ©: 12/04 06:05', color: 'bg-purple-100 border-l-4 border-purple-500' },
                    { type: 'sight', title: 'è§€å…‰æ™¯é»', content: 'ç±³è˜­å¤§æ•™å ‚ (å¤–è§€)ã€è‰¾æ›¼ç´äºŒä¸–è¿´å»Š', color: 'bg-red-100' },
                    { type: 'f1', title: 'ğŸï¸ F1 é˜¿å¸ƒé”æ¯”ç«™ æ’ä½è³½', content: 'é˜¿å¸ƒé”æ¯” 18:00<br>ğŸ‡®ğŸ‡¹ ç¾©å¤§åˆ©ç›´æ’­ 15:00', specialClass: 'f1-card' },
                    { type: 'meal', title: 'æ—©é¤', content: 'æ©Ÿä¸Šé¤é£Ÿ', color: 'bg-green-50' },
                    { type: 'meal', title: 'åˆé¤ (è‡ªç†æ¨è–¦)', content: '<a href="https://www.google.com/maps/search/?api=1&query=Luini+Milano" target="_blank" class="text-blue-600 underline font-bold">ğŸ“Luini (ç‚¸ä¸‰æ˜æ²» â‚¬3)</a> æˆ– <a href="https://www.google.com/maps/search/?api=1&query=Spontini+Milano+Duomo" target="_blank" class="text-blue-600 underline font-bold">ğŸ“Spontini (åšæ¯”è–© â‚¬6)</a> - éƒ½åœ¨æ•™å ‚æ—ï¼Œå¹³åƒ¹ç¾å‘³', color: 'bg-yellow-100' },
                    { type: 'meal', title: 'æ™šé¤', content: 'ç±³è˜­ç‡‰é£¯é¢¨å‘³æ–™ç†', color: 'bg-green-100' },
                ],
                hotel: { name: 'UNAHOTELS MALPENSA', mapQuery: 'UNAHOTELS+Malpensa', note: 'ä½æ–¼ç±³è˜­é¦¬çˆ¾å½­è–©æ©Ÿå ´é™„è¿‘ï¼Œç¾ä»£åŒ–èˆ’é©é£¯åº—ã€‚' },
                highlights: [{ type: 'eat', name: 'Luini Panzerotti', link: 'Luini+Milano', desc: 'ç±³è˜­å¿…åƒç™¾å¹´ç‚¸ä¸‰æ˜æ²»è€åº—ã€‚' }, { type: 'buy', name: 'KIKO å½©å¦', link: 'KIKO+Milano', desc: 'ç¾©å¤§åˆ©å¹³åƒ¹å½©å¦ç‹è€…ã€‚' }]
            },
            {
                day: 3, date: '12/07 (æ—¥)', location: 'é¦¬ç„¦é›·æ¹– â†’ ç¶­æ´›ç´ (Verona)', lat: 45.4384, lng: 10.9916, locationName: 'ğŸ“ ç¶­æ´›ç´ Verona', weather: { temp: '-1Â°C - 7Â°C', icon: 'ğŸŒ«ï¸', condition: 'å¤šéœ§/å¯’å†·', currentTemp: '3Â°C' },
                main: 'åŒ—ç¾©æ¹–å€ & F1 æ­£è³½',
                details: [
                    { type: 'f1', title: 'ğŸ F1 é˜¿å¸ƒé”æ¯”ç«™ æ­£è³½', content: 'é˜¿å¸ƒé”æ¯” 17:00<br>ğŸ‡®ğŸ‡¹ ç¾©å¤§åˆ©ç›´æ’­ 14:00', specialClass: 'f1-card' },
                    { type: 'traffic', title: 'é¦¬ç„¦é›·æ¹– éŠèˆ¹', content: 'åŒ—ç¾©æ¹–å€éŠèˆ¹é«”é©—ï¼Œæ¬£è³æ¹–å…‰å±±è‰²ã€‚', color: 'bg-indigo-100' },
                    { type: 'sight', title: 'ç¶­æ´›ç´å¤åŸ', content: 'åœ“å½¢ç«¶æŠ€å ´ (å¤–è§€)ã€èŒ±éº—è‘‰æ•…å±… (å¤–è§€)', color: 'bg-red-100' },
                    { type: 'meal', title: 'æ—©é¤', content: 'é£¯åº—å…§æ—©é¤', color: 'bg-green-50' }, { type: 'meal', title: 'åˆé¤', content: 'è¥¿å¼é¢¨å‘³æ–™ç†', color: 'bg-green-100' }, { type: 'meal', title: 'æ™šé¤', content: 'ç™¾å¹´æ•™å ‚ç¾©å¼æŠ«è–©é¢¨å‘³æ–™ç†', color: 'bg-green-100' }
                ],
                hotel: { name: 'BEST WESTERN CTC HOTEL VERONA', mapQuery: 'Best+Western+CTC+Hotel+Verona', note: 'ä½æ–¼ç¶­æ´›ç´éƒŠå€ã€‚' },
                highlights: [{ type: 'visit', name: 'èŒ±éº—è‘‰ä¹‹å®¶', link: 'Casa+di+Giulietta', desc: 'æ„›æƒ…è–åœ°ã€‚' }]
            },
            {
                day: 4, date: '12/08 (ä¸€)', location: 'å¨å°¼æ–¯ (Venice)', lat: 45.4408, lng: 12.3155, locationName: 'ğŸ“ å¨å°¼æ–¯ Venice', weather: { temp: '3Â°C - 8Â°C', icon: 'ğŸŒ§ï¸', condition: 'æ½®æ¿•/å¶é›¨', currentTemp: '6Â°C' },
                main: 'æ°´éƒ½å··å¼„æ•£ç­–èˆ‡è²¢å¤šæ‹‰',
                details: [
                    { type: 'sight', title: 'å¨å°¼æ–¯æœ¬å³¶', content: 'å··å¼„æ•£ç­–ã€è²¢å¤šæ‹‰é«”é©— (5äººä¸€è‰˜)', color: 'bg-red-100' },
                    { type: 'meal', title: 'æ—©é¤', content: 'é£¯åº—å…§æ—©é¤', color: 'bg-green-50' }, { type: 'meal', title: 'åˆé¤', content: 'å¨å°¼æ–¯å¢¨é­šéºµä½ç‚¸æµ·é®®', color: 'bg-green-100' },
                    { type: 'meal', title: 'æ™šé¤ (è‡ªç†æ¨è–¦)', content: '<a href="https://www.google.com/maps/search/?api=1&query=Dal+Moro\'s+Fresh+Pasta+to+Go" target="_blank" class="text-blue-600 underline font-bold">ğŸ“Dal Moro\'s (å¤–å¸¶ç¾©å¤§éºµ â‚¬8)</a> æˆ– <a href="https://www.google.com/maps/search/?api=1&query=Fried+Land+Venice" target="_blank" class="text-blue-600 underline font-bold">ğŸ“Fried Land (ç‚¸æµ·é®® â‚¬10)</a>', color: 'bg-yellow-100' }
                ],
                hotel: { name: 'CROWNE PLAZA PADOVA', mapQuery: 'Crowne+Plaza+Padova', note: 'ä½æ–¼å¸•å¤šç“¦ã€‚' },
                highlights: [{ type: 'eat', name: 'Dal Moro\'s Pasta', link: 'Dal+Moro\'s+Fresh+Pasta+to+Go', desc: 'è¶…äººæ°£å¤–å¸¶ç¾©å¤§åˆ©éºµã€‚' }]
            },
            { day: 5, date: '12/09 (äºŒ)', location: 'ä½›ç¾…å€«æ–¯', lat: 43.7696, lng: 11.2558, locationName: 'ğŸ“ ä½›ç¾…å€«æ–¯', weather: { temp: '2Â°C - 11Â°C', icon: 'ğŸŒ¤ï¸', condition: 'æ™´æ™‚å¤šé›²', currentTemp: '8Â°C' }, main: 'æ–‡è—å¾©èˆˆæµªæ¼«ä¹‹æ—…', details: [ { type: 'sight', title: 'å¸‚å€è§€å…‰', content: 'è–æ¯ç™¾èŠ±å¤§æ•™å ‚ã€é ˜ä¸»å»£å ´', color: 'bg-red-100' }, { type: 'meal', title: 'æ—©/åˆ/æ™šé¤', content: 'é£¯åº—/ç‰›æ’é¢¨å‘³/ä¸­å¼', color: 'bg-green-50' } ], hotel: { name: 'GRAND HOTEL CROCE DI MALTA', mapQuery: 'Grand+Hotel+Croce+di+Malta', note: 'æº«æ³‰å°é®ã€‚' }, highlights: [{ type: 'eat', name: 'ä¸­å¤®å¸‚å ´ç‰›è‚šåŒ…', link: 'Da+Nerbone', desc: 'æ’éšŠç¾é£Ÿã€‚' }] },
            { day: 6, date: '12/10 (ä¸‰)', location: 'äº”æ¼æ‘ â†’ æ¯”è–©', lat: 44.1270, lng: 9.7094, locationName: 'ğŸ“ äº”æ¼æ‘', weather: { temp: '6Â°C - 12Â°C', icon: 'â˜€ï¸', condition: 'æ™´æœ—', currentTemp: '10Â°C' }, main: 'ç¹½ç´›äº”æ¼æ‘èˆ‡èˆ‰ä¸–æ–œå¡”', details: [ { type: 'traffic', title: 'ç«è»ŠéŠäº”æ¼æ‘', content: 'æ­ç«è»ŠéŠè¦½å…©å€‹æ¼æ‘', color: 'bg-indigo-100' }, { type: 'meal', title: 'åˆé¤ (è‡ªç†)', content: '<a href="https://www.google.com/maps/search/?api=1&query=Il+Pescato+Cucinato+Riomaggiore" target="_blank" class="text-blue-600 underline font-bold">ğŸ“Il Pescato Cucinato (ç‚¸æµ·é®®ç­’ â‚¬10)</a>', color: 'bg-yellow-100' } ], hotel: { name: 'AC HOTEL PISA', mapQuery: 'AC+Hotel+Pisa', note: 'æ¯”è–©è¿‘éƒŠã€‚' }, highlights: [{ type: 'eat', name: 'ç‚¸æµ·é®®ç­’', link: 'Il+Pescato+Cucinato+Riomaggiore', desc: 'æ–°é®®ç¾ç‚¸ã€‚' }] },
            { day: 7, date: '12/11 (å››)', location: 'æ‰˜æ–¯å¡å°¼ â†’ ç¾…é¦¬', lat: 43.0773, lng: 11.6123, locationName: 'ğŸ“ çš®æ©è–©', weather: { temp: '2Â°C - 11Â°C', icon: 'ğŸŒ¤ï¸', condition: 'æ¶¼çˆ½', currentTemp: '7Â°C' }, main: 'æ‰˜æ–¯å¡å°¼æ…¢æ´»ä¹‹æ—…', details: [ { type: 'sight', title: 'é…’èŠå“é…’', content: 'è’™ç‰¹æ™®é½Šäºè«¾', color: 'bg-red-100' }, { type: 'meal', title: 'æ—©/åˆ/æ™šé¤', content: 'é£¯åº—/è¥¿å¼/ä¸­å¼', color: 'bg-green-50' } ], hotel: { name: 'WARMTHOTEL', mapQuery: 'Warmthotel+Rome', note: 'ç¾…é¦¬EURå€ã€‚' }, highlights: [{ type: 'buy', name: 'ç´…é…’', link: 'Tuscany+Winery', desc: 'Chiantiã€‚' }] },
            { day: 8, date: '12/12 (äº”)', location: 'ç¾…é¦¬ (Rome)', lat: 41.9028, lng: 12.4964, locationName: 'ğŸ“ ç¾…é¦¬', weather: { temp: '6Â°C - 13Â°C', icon: 'â˜€ï¸', condition: 'æ™´æœ—', currentTemp: '10Â°C' }, main: 'æ°¸æ†ä¹‹åŸå¸‚å€è§€å…‰', details: [ { type: 'sight', title: 'å¸‚å€è§€å…‰', content: 'ç«¶æŠ€å ´ã€è¨±é¡˜æ± ã€è–å½¼å¾—æ•™å ‚', color: 'bg-red-100' }, { type: 'meal', title: 'æ—©/åˆ/æ™šé¤', content: 'é£¯åº—/ä¸­å¼/å°ç¾”ç¾Š', color: 'bg-green-50' } ], hotel: { name: 'WARMTHOTEL', mapQuery: 'Warmthotel+Rome', note: 'çºŒä½ã€‚' }, highlights: [{ type: 'eat', name: 'é‡‘æ¯å’–å•¡', link: 'Tazza+d\'Oro+Rome', desc: 'å¿…å–Espressoã€‚' }] },
            { day: 9, date: '12/13 (å…­)', location: 'ç¾…é¦¬ â†’ æœæ‹œ', lat: 41.7137, lng: 12.4439, locationName: 'ğŸ“ ç¾…é¦¬ Outlet', weather: { temp: '6Â°C - 13Â°C', icon: 'ğŸ›ï¸', condition: 'è³¼ç‰©æ—¥', currentTemp: '11Â°C' }, main: 'Outlet è³¼ç‰©å¤©å ‚', details: [ { type: 'sight', title: 'Castel Romano Outlet', content: 'åç‰ŒæŠ˜æ‰£æ‘', color: 'bg-red-100' }, { type: 'flight', title: 'EK098', content: '14:55 FCO âœˆï¸ 23:30 DXB', color: 'bg-blue-100' }, { type: 'checkin', title: 'â° ç·šä¸Šå ±åˆ°', content: 'å°ç£æ™‚é–“ 12/11 21:55', color: 'bg-purple-100 border-l-4 border-purple-500' }, { type: 'meal', title: 'åˆé¤ (è‡ªç†)', content: 'Outlet å…§è¼•é£Ÿ', color: 'bg-yellow-100' } ], highlights: [{ type: 'buy', name: 'ç²¾å“', link: 'Castel+Romano+Designer+Outlet', desc: 'æŠŠæ¡æ©Ÿæœƒã€‚' }] },
            { day: 10, date: '12/14 (æ—¥)', location: 'æœæ‹œ â†’ å°åŒ—', lat: 25.2532, lng: 55.3657, locationName: 'ğŸ“ æœæ‹œ', weather: { temp: '19Â°C - 26Â°C', icon: 'â˜€ï¸', condition: 'æº«æš–', currentTemp: '22Â°C' }, main: 'çµæŸç¾å¥½çš„æ—…ç¨‹', details: [ { type: 'flight', title: 'EK366', content: '03:40 DXB âœˆï¸ 15:35 TPE', color: 'bg-blue-100' }, { type: 'checkin', title: 'â° ç·šä¸Šå ±åˆ°', content: 'å°ç£æ™‚é–“ 12/12 07:40', color: 'bg-purple-100 border-l-4 border-purple-500' } ] }
        ];

        const shoppingList = [ 
            { category: 'æœæ‹œæ©Ÿå ´ Dubai Airport', items: [ { name: 'Patchi å·§å…‹åŠ›', desc: 'ä¸­æ±æ„›é¦¬ä»•', img: 'https://m.media-amazon.com/images/I/61Kk-y+XQ0L.jpg' }, { name: 'Bateel æ¤°æ£—', desc: 'é ‚ç´šçš‡å®¶æ¤°æ£—', img: 'https://bateel.com/media/catalog/product/cache/7c0337d38006fa738497220226273252/k/h/kholas_plain.jpg' }, { name: 'é§±é§å¥¶çš‚', desc: 'ä¿æ¿•æ»‹æ½¤', img: 'https://images-na.ssl-images-amazon.com/images/I/71%2BgvKqK3IL._AC_SL1500_.jpg' } ] }, 
            { category: 'ç¾©å¤§åˆ©è¶…å¸‚', items: [ { name: 'Pocket Coffee', desc: 'æ¿ƒç¸®å’–å•¡å·§å…‹åŠ›', img: 'https://www.ferrero.it/content/dam/ferrero/it/assets/pocket-coffee/product/Pocket-Coffee-Pack-18-pezzi.png' }, { name: 'Marvis ç‰™è†', desc: 'ç‰™è†ç•Œæ„›é¦¬ä»•', img: 'https://m.media-amazon.com/images/I/61X+yKk+XQL._AC_SL1000_.jpg' }, { name: 'Limoncello', desc: 'æª¸æª¬é…’', img: 'https://upload.wikimedia.org/wikipedia/commons/thumb/4/46/Limoncello.jpg/320px-Limoncello.jpg' }, { name: 'æ¾éœ²é†¬', desc: 'æ‹Œéºµç¥ç‰©', img: 'https://m.media-amazon.com/images/I/81y+yKk+XQL._AC_SL1500_.jpg' } ] } 
        ];
        
        const notesData = [ { category: 'F1 ç›´æ’­', icon: 'tv', color: 'bg-red-100', text: '1. VPNå›å°ç£çœ‹æ„›çˆ¾é”<br>2. é£¯åº—Sky Sport F1<br>3. æ‰¾Sports Bar' }, { category: 'é˜²é¨™', icon: 'alert-triangle', color: 'bg-orange-100', text: 'å°å¿ƒå¹¸é‹æ‰‹ç’°ã€å‰æ™®è³½äºº' } ];

        let currentDayIndex = 0, currentTab = 'itinerary', expenses = JSON.parse(localStorage.getItem('italy_expenses')) || [], myPlaces = JSON.parse(localStorage.getItem('italy_my_places')) || [];
        let googleWebAppUrl = 'https://script.google.com/macros/s/AKfycbz2NYU8pDejverPJgXEzeVg8KGiMbqjJXU5mO2XgB7iQ8Zt-eF5rO6R7-G1e0lP8XU/exec';
        const locations = [{ id: 'Milan', name: 'ğŸ“ ç±³è˜­' }, { id: 'Verona', name: 'ğŸ“ ç¶­æ´›ç´' }, { id: 'Venice', name: 'ğŸ“ å¨å°¼æ–¯' }, { id: 'Florence', name: 'ğŸ“ ä½›ç¾…å€«æ–¯' }, { id: 'CinqueTerre', name: 'ğŸ“ äº”æ¼æ‘' }, { id: 'Pisa', name: 'ğŸ“ æ¯”è–©' }, { id: 'Pienza', name: 'ğŸ“ çš®æ©è–©' }, { id: 'Rome', name: 'ğŸ“ ç¾…é¦¬' }, { id: 'Dubai', name: 'ğŸ“ æœæ‹œ' }, { id: 'Other', name: 'ğŸ“ å…¶ä»–' }];

        // --- 2. HELPER FUNCTIONS (Defined first to avoid ReferenceError) ---
        function getIconName(t) { return {sight:'aperture', flight:'plane', traffic:'bus', meal:'utensils', f1:'trophy', info:'info', checkin:'alarm-clock'}[t] || 'map-pin'; }
        function getCategoryIcon(cat) { const map = { 'gelato': 'ğŸ¦', 'coffee': 'â˜•', 'food': 'ğŸ', 'shopping': 'ğŸ›ï¸', 'spot': 'ğŸ“·', 'other': 'ğŸ“' }; return map[cat] || 'ğŸ“'; }
        function showMessage(t, i) { document.getElementById('message-modal').classList.remove('hidden'); document.getElementById('modal-text').innerText = t; document.getElementById('modal-icon').innerHTML = `<i data-lucide="${i}" class="w-10 h-10"></i>`; lucide.createIcons(); }
        function closeModal() { document.getElementById('message-modal').classList.add('hidden'); }
        function showConfirm(text, callback) { window.confirmCallback = callback; document.getElementById('confirm-modal').classList.remove('hidden'); document.getElementById('confirm-text').innerText = text; }
        function closeConfirm(result) { document.getElementById('confirm-modal').classList.add('hidden'); if (window.confirmCallback) window.confirmCallback(result); }

        function createItineraryCard(item) {
            const detailCards = item.details.map(detail => {
                if(detail.specialClass) return `<div class="${detail.specialClass} p-3 rounded-xl flex items-center justify-between text-sm mb-2"><div class="flex items-center"><span class="text-2xl mr-3">ğŸï¸</span><div><p class="f1-title text-lg">${detail.title.replace('ğŸï¸ ', '')}</p><p class="text-xs opacity-90 font-mono">${detail.content}</p></div></div><span class="text-2xl">ğŸ</span></div>`;
                return `<div class="${detail.color} p-3 rounded-xl flex items-start text-sm border border-gray-300 mb-2"><i data-lucide="${getIconName(detail.type)}" class="w-4 h-4 mr-2 mt-0.5 flex-shrink-0 text-gray-700"></i><div class="w-full"><p class="font-semibold text-gray-700">${detail.title}</p><p class="text-gray-600">${detail.content}</p></div></div>`;
            }).join('');
            let hotelSection = item.hotel ? `<div class="mt-6 mb-4"><div class="flex items-center mb-2"><div class="tag bg-blue-600 text-white mr-2"><i data-lucide="bed-double" class="w-3 h-3 mr-1"></i> ä»Šæ™šä½å®¿</div><h4 class="font-bold text-gray-800 text-sm">${item.hotel.name}</h4></div><p class="text-xs text-gray-500 mb-2">${item.hotel.note}</p><div class="map-container shadow-md mb-2"><iframe src="https://maps.google.com/maps?q=${item.hotel.mapQuery}&t=&z=14&ie=UTF8&iwloc=&output=embed" frameborder="0" style="border:0;" allowfullscreen="" loading="lazy"></iframe></div><a href="https://www.google.com/maps/search/supermarket+near+${item.hotel.mapQuery}" target="_blank" class="block w-full bg-white border border-blue-300 text-blue-600 text-center py-2 rounded-lg text-sm font-semibold hover:bg-blue-50 transition"><i data-lucide="shopping-basket" class="w-4 h-4 inline-block mr-1"></i> å°‹æ‰¾é™„è¿‘è¶…å¸‚</a></div>` : '';
            let highlightsSection = item.highlights ? `<div class="mt-4 mb-6 border-t border-dashed border-gray-300 pt-4"><h4 class="font-bold text-gray-700 mb-3 flex items-center"><i data-lucide="star" class="w-4 h-4 mr-1 text-yellow-500 fill-current"></i> ä»Šæ—¥æ¨è–¦ â€¢ å¿…åƒå¿…è²·</h4><div>${item.highlights.map(h => { let icon, colorClass, label; if (h.type === 'eat') { icon = 'utensils-crossed'; colorClass = 'text-orange-600 bg-orange-50 border-orange-200'; label = 'å¿…åƒ'; } else if (h.type === 'buy') { icon = 'shopping-bag'; colorClass = 'text-pink-600 bg-pink-50 border-pink-200'; label = 'å¿…è²·'; } else if (h.type === 'visit') { icon = 'map-pin'; colorClass = 'text-green-600 bg-green-50 border-green-200'; label = 'å¿…è¨ª'; } else { icon = 'camera'; colorClass = 'text-indigo-600 bg-indigo-50 border-indigo-200'; label = 'å¿…å»'; } const googleMapLink = `https://www.google.com/maps/search/?api=1&query=${h.link}`; return `<a href="${googleMapLink}" target="_blank" class="block mb-2 group"><div class="${colorClass} border p-2 rounded-lg flex items-center transition group-hover:shadow-md"><div class="flex-shrink-0 w-8 h-8 rounded-full bg-white flex items-center justify-center mr-3 shadow-sm"><i data-lucide="${icon}" class="w-4 h-4"></i></div><div class="flex-grow"><div class="flex items-center justify-between"><p class="font-bold text-sm text-gray-800">${h.name}</p><span class="text-[10px] uppercase font-bold px-1.5 py-0.5 rounded bg-white bg-opacity-50">${label}</span></div><p class="text-xs text-gray-600 truncate">${h.desc}</p></div><i data-lucide="chevron-right" class="w-4 h-4 opacity-50"></i></div></a>`; }).join('')}</div></div>` : '';
            let weatherHtml = item.weather ? `<div class="bg-[#e0f2f1] text-teal-800 p-3 rounded-xl mb-4 flex justify-between items-center shadow-inner border border-teal-300 relative z-10"><div class="flex flex-col"><div class="font-bold text-xl">${item.weather.icon} ${item.weather.temp}</div><div class="text-xs text-gray-500 mt-1">ç›®å‰: ${item.weather.currentTemp}</div></div><div class="text-right text-sm"><p class="font-semibold text-xs text-teal-600 uppercase">${item.locationName}</p><p class="font-bold">${item.weather.condition}</p></div></div>` : `<div class="bg-gray-100 text-gray-500 p-3 rounded-xl mb-4 flex justify-center items-center shadow-inner border border-gray-200 relative z-10"><span class="spinner mr-2"></span> æ­£åœ¨è¼‰å…¥ ${item.locationName} æ°£æº«...</div>`;
            const mainTitle = item.main ? `<div class="text-center mb-4 relative z-10"><h2 class="text-lg font-bold text-gray-800 border-b-2 border-red-200 inline-block pb-1">${item.main}</h2></div>` : '';
            return `<div class="scrapbook-card bg-white p-5 rounded-3xl border-2 border-[#5a5a5a] relative overflow-hidden"><div class="absolute top-0 right-0 w-16 h-16 bg-yellow-100 rounded-bl-full -mr-8 -mt-8 z-0 opacity-50"></div><div class="border-b-2 border-dashed border-gray-300 pb-3 mb-4 relative z-10"><h3 class="text-xl font-extrabold text-gray-800">${item.location}</h3></div>${weatherHtml}${mainTitle}<div class="space-y-1 relative z-10">${detailCards}</div>${highlightsSection}${hotelSection}</div>`;
        }

        function createNoteCard(note) {
             return `<div class="p-4 rounded-xl shadow-lg scrapbook-card bg-white relative"><div class="absolute top-0 right-0 p-2 transform -translate-x-1 -translate-y-1 rounded-full ${note.color}"><i data-lucide="${note.icon}" class="w-5 h-5 text-gray-700"></i></div><h3 class="text-lg font-bold text-gray-800 mb-2 text-red-600">${note.category}</h3><p class="text-gray-600 text-sm leading-relaxed">${note.text}</p></div>`;
        }

        // --- 3. MAIN RENDER FUNCTIONS ---
        function renderApp() {
            lucide.createIcons();
            const main = document.getElementById('main-content');
            main.className = 'pb-4';
            if (currentTab === 'itinerary') renderItinerary(main);
            else if (currentTab === 'places') renderPlaces(main);
            else if (currentTab === 'expenses') renderExpenses(main);
            else if (currentTab === 'notes') renderNotes(main);
            lucide.createIcons();
        }

        function renderItinerary(container) {
            document.getElementById('header-day-display').style.display = 'inline-block';
            document.getElementById('header-day-display').innerText = `Day ${currentDayIndex + 1}`;
            container.innerHTML = `
                <div class="day-selector mb-4 px-2">${itineraryData.map((_, idx) => `<button onclick="setDay(${idx})" class="day-chip ${idx === currentDayIndex ? 'active' : ''}">Day ${idx + 1}</button>`).join('')}</div>
                <div id="day-card-container" class="fade-in">${createItineraryCard(itineraryData[currentDayIndex])}</div>`;
            checkAndFetchWeather(currentDayIndex);
        }

        function renderPlaces(container) {
            document.getElementById('header-day-display').style.display = 'none';
            const groupedPlaces = myPlaces.reduce((acc, place) => { const loc = place.location || 'Other'; if (!acc[loc]) acc[loc] = []; acc[loc].push(place); return acc; }, {});
            const locationOptions = locations.map(l => `<option value="${l.id}">${l.name}</option>`).join('');
            let listHtml = myPlaces.length === 0 ? '<p class="text-center text-gray-400 py-8">å°šç„¡ç§æˆ¿é»</p>' : '';
            if (myPlaces.length > 0) {
                locations.forEach(locObj => {
                    const placesInLoc = groupedPlaces[locObj.id];
                    if (placesInLoc && placesInLoc.length > 0) {
                        listHtml += `<div class="mb-6"><h3 class="font-bold text-lg text-gray-700 mb-2 border-b border-gray-200 pb-1 cursor-pointer flex justify-between items-center" onclick="toggleGroup('${locObj.id}')">${locObj.name}<i data-lucide="chevron-down" class="w-4 h-4 transition-transform" id="icon-${locObj.id}"></i></h3><div id="group-${locObj.id}" class="space-y-3 transition-all duration-300 overflow-hidden">${placesInLoc.slice().reverse().map(p => `<div class="bg-white p-3 rounded-xl border border-gray-200 shadow-sm mb-2"><div class="flex justify-between"><div class="flex items-center gap-2"><span class="text-xl">${getCategoryIcon(p.category)}</span><div><h4 class="font-bold text-gray-800">${p.name}</h4><p class="text-xs text-gray-500">${p.note||''}</p></div></div><a href="${p.link}" target="_blank" class="text-blue-600"><i data-lucide="navigation" class="w-4 h-4"></i></a></div></div>`).join('')}</div></div>`;
                    }
                });
            }
            container.innerHTML = `<div class="px-2 fade-in"><div class="flex justify-between mb-4"><h2 class="text-xl font-bold text-gray-800 flex items-center"><i data-lucide="map" class="w-5 h-5 mr-2 text-blue-600"></i> ç§æˆ¿é»</h2><button onclick="syncFromCloud()" class="bg-blue-100 text-blue-700 px-3 py-1 rounded-lg text-xs font-bold flex items-center"><i data-lucide="refresh-cw" class="w-3 h-3 mr-1"></i> åŒæ­¥</button></div><div class="bg-white p-4 rounded-xl scrapbook-card mb-6"><div class="space-y-3"><input type="text" id="place-name" placeholder="åº—å" class="w-full border rounded p-2 text-sm"><div class="flex gap-2"><select id="place-location" class="w-1/2 border rounded p-2 text-sm bg-white">${locationOptions}</select><select id="place-category" class="w-1/2 border rounded p-2 text-sm bg-white"><option value="gelato">ğŸ¦ å†°æ·‡æ·‹</option><option value="coffee">â˜• å’–å•¡</option><option value="food">ğŸ ç¾é£Ÿ</option><option value="shopping">ğŸ›ï¸ è³¼ç‰©</option><option value="spot">ğŸ“· æ™¯é»</option><option value="other">ğŸ“ å…¶ä»–</option></select></div><input type="text" id="place-link" placeholder="Google Maps Link" class="w-full border rounded p-2 text-sm"><input type="text" id="place-note" placeholder="å‚™è¨»" class="w-full border rounded p-2 text-sm"><button id="add-place-btn" onclick="addPlace()" class="w-full bg-blue-600 text-white py-2 rounded font-bold text-sm">åŠ å…¥</button></div></div>${listHtml}</div>`;
        }

        function renderExpenses(container) {
            document.getElementById('header-day-display').style.display = 'none';
            const totalEUR = expenses.reduce((sum, item) => { if (item.currency === 'AED') return sum + (item.amount * 0.25); return sum + item.amount; }, 0);
            let listHtml = expenses.length === 0 ? '<p class="text-center text-gray-400 py-8">å°šç„¡æ”¯å‡º</p>' : expenses.slice().reverse().map(e => `<div class="flex justify-between border-b py-2"><span class="text-sm">${e.item}</span><span class="font-bold text-sm">â‚¬${e.amount}</span></div>`).join('');
            container.innerHTML = `<div class="px-2 fade-in"><div class="flex justify-between mb-4"><h2 class="text-xl font-bold text-gray-800 flex items-center"><i data-lucide="wallet" class="w-5 h-5 mr-2 text-red-600"></i> è¨˜å¸³ (ç¸½è¨ˆç´„ â‚¬${totalEUR.toFixed(2)})</h2><button onclick="syncFromCloud()" class="bg-blue-100 text-blue-700 px-3 py-1 rounded-lg text-xs font-bold flex items-center"><i data-lucide="refresh-cw" class="w-3 h-3 mr-1"></i> åŒæ­¥</button></div><div class="bg-white p-4 rounded-xl scrapbook-card mb-6"><div class="flex gap-2 mb-2"><input type="text" id="exp-item" placeholder="é …ç›®" class="flex-1 border rounded p-2 text-sm"><input type="number" id="exp-amount" placeholder="â‚¬" class="w-20 border rounded p-2 text-sm"></div><button id="add-exp-btn" onclick="addExpense()" class="w-full bg-gray-800 text-white py-2 rounded font-bold text-sm">æ–°å¢</button></div>${listHtml}</div>`;
        }

        function renderNotes(container) {
            document.getElementById('header-day-display').style.display = 'none';
            const items = shoppingList.map(cat => `<div class="bg-white p-4 rounded-xl scrapbook-card mb-6"><h3 class="font-bold mb-2">${cat.category}</h3><div class="grid grid-cols-2 gap-2">${cat.items.map(i => `<div class="border rounded p-2 text-center"><img src="${i.img}" class="w-full h-20 object-contain mb-1" onerror="this.src='https://placehold.co/100x100?text=No+Image'"><p class="text-xs font-bold">${i.name}</p></div>`).join('')}</div></div>`).join('');
            container.innerHTML = `<div class="px-2 fade-in"><h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center"><i data-lucide="gift" class="w-5 h-5 mr-2 text-pink-600"></i> å¿…è²·æ¨è–¦</h2>${items}<h2 class="text-xl font-bold text-gray-800 mb-4 px-2 flex items-center mt-8"><i data-lucide="clipboard-list" class="w-5 h-5 mr-2 text-red-600"></i> æ—…éŠé ˆçŸ¥</h2><div class="space-y-6 pb-4">${notesData.map(createNoteCard).join('')}</div></div>`;
        }

        // --- 4. LOGIC FUNCTIONS ---
        function setDay(idx) { currentDayIndex = idx; renderApp(); }
        function changeDay(off) { let n = currentDayIndex + off; if(n >= 0 && n < itineraryData.length) setDay(n); }
        function switchTab(tab) { currentTab = tab; document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active')); document.getElementById(`nav-${tab}`).classList.add('active'); renderApp(); }
        function toggleGroup(id) { const group = document.getElementById(`group-${id}`); const icon = document.getElementById(`icon-${id}`); if (group.style.display === 'none') { group.style.display = 'block'; icon.style.transform = 'rotate(0deg)'; } else { group.style.display = 'none'; icon.style.transform = 'rotate(-90deg)'; } }
        
        function checkAndFetchWeather(index) { /* Keep weather fetch simple or assume defaults for now to prevent errors */ }

        // JSONP Callback
        window.jsonpCallback = function(data) {
            if (data.expenses) { expenses = data.expenses; localStorage.setItem('italy_expenses', JSON.stringify(expenses)); }
            if (data.places) { myPlaces = data.places; localStorage.setItem('italy_my_places', JSON.stringify(myPlaces)); }
            showMessage("åŒæ­¥æˆåŠŸï¼", "check-circle");
            renderApp();
        };

        function syncFromCloud() {
            const script = document.createElement('script');
            script.src = googleWebAppUrl + '?callback=jsonpCallback&t=' + Date.now();
            document.body.appendChild(script);
            showMessage("åŒæ­¥è«‹æ±‚å·²ç™¼é€...", "loader");
        }

        function addPlace() {
            const name = document.getElementById('place-name').value, link = document.getElementById('place-link').value;
            const location = document.getElementById('place-location').value, category = document.getElementById('place-category').value;
            const note = document.getElementById('place-note').value;
            if(!name || !link) return showMessage('è«‹è¼¸å…¥åº—åå’Œé€£çµ', 'alert-circle');
            const p = { name, link, location, category, note };
            myPlaces.push(p); localStorage.setItem('italy_my_places', JSON.stringify(myPlaces));
            
            const btn = document.getElementById('add-place-btn');
            btn.disabled = true; btn.innerText = 'åŒæ­¥ä¸­...';
            
            fetch(googleWebAppUrl, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ type: 'place', ...p }) })
                .finally(() => { btn.disabled = false; btn.innerText = 'åŠ å…¥'; renderApp(); });
        }

        function addExpense() {
            const item = document.getElementById('exp-item').value, amount = document.getElementById('exp-amount').value;
            const currency = document.getElementById('exp-currency').value;
            if(!item || !amount) return;
            const e = { date: new Date().toISOString(), item, currency, amount: parseFloat(amount) };
            expenses.push(e); localStorage.setItem('italy_expenses', JSON.stringify(expenses));
            
            const btn = document.getElementById('add-exp-btn');
            btn.disabled = true; btn.innerText = 'åŒæ­¥ä¸­...';

            fetch(googleWebAppUrl, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ type: 'expense', ...e }) })
                .finally(() => { btn.disabled = false; btn.innerText = 'æ–°å¢'; renderApp(); });
        }

        // --- 5. INIT ---
        window.onload = () => { renderApp(); };
    </script>
</body>
</html>
